\chapter{Design og implementasjon av et skytilkoblet pulsoksimeter}
\label{ch:implementation1}

Kapittelet beskriver hvordan en prototype av et skytilkoblet pulsoksimeter med innebygget autentisering ble utviklet.
Første del av kapittelet handler om valg av teknologien før blabla

\section{Komponentoversikt}
Løsningen består av følgende komponenter:

\begin{itemize}
  \item Raspberry Pi Zero W
  \item GT-511C3 (fingeravtrykksensor)
  \item Nonin 3230 (pulsoksimeter med \gls{ble})
  \item Standard trykknapp
  \item Tre RGB-lysdioder og én hvit lysdiode
  \item 3D-printet hus
\end{itemize}

Komponentene ble presentert i forrige kapittel. Raspberry Pi Zero W ble valgt som prototypeplattform istedenfor
alternativer som Tessel 2 og Arduino Yún. Det var et ønske om å bruke JavaScript og Node.js som utviklingsmiljø, og Arduino
bruker C/C++ som utviklingsspråk. Tessel 2 er en prototypeplattform basert på Node.js, men har få konfigurasjonsmuligheter
og \gls{ble} er ikke innebygget.

Oversikt over løsningen med hvordan komponentene kommuniserer med Raspberry Pi er i figur \ref{fig:prototypeoversikt}.

\begin{figure}
\includegraphics[width=0.55\textwidth, center]{fig/prototype/oversiktlosning}
\caption{Sammenhengen mellom de ulike komponentene}
\label{fig:prototypeoversikt}
\end{figure}

\section{Implementasjon av komponenter}

\subsection{Trykknapp og lysdioder}
Figur \ref{fig:breadboard} viser hvordan trykknappen og lysdiodene er koblet på
portene til Raspberry Pi med et \textit{breadboard}. Oppkoblingen er logisk ekvivalent med prototypen.
I selve prototypen er to RGB-lysdioder og en knapp loddet fast med motstander på et et lite brett (se figur \ref{fig:brett}).
Koblingsskjemaet er i figur \ref{fig:schematics}. Alle komponentene deler felles jord.

\begin{figure}
\includegraphics[width=0.75\textwidth, center]{fig/prototype/breadbord}
\caption{Oppkobling av trykknapp og lysdioder}
\label{fig:breadboard}
\end{figure}

\begin{figure}
\includegraphics[width=0.65\textwidth, center]{fig/prototype/ekte_knappleds}
\caption{Oppkobling av trykknapp og lysdioder på brett}
\label{fig:brett}
\end{figure}

\begin{figure}
\includegraphics[width=0.95\textwidth, center]{fig/prototype/schmeatic}
\caption{Koblingsskjema av trykknapp og lysdioder}
\label{fig:schematics}
\end{figure}

For å gjøre håndteringen av knapp og lysdioder enklere, ble det utviklet et lite JavaScript-bibliotek.
Koden til dette biblioteket er lagt ved i tillegg \ref{appendix:pigpio-components}. Kodesnutt
\ref{lst:pigpio-components-usage} er et eksempel på bruk av dette biblioteket med den samme oppkoblingen som i
figur \ref{fig:breadboard}.

\begin{lstlisting}[frame=single, language=JavaScript,
    caption=Bruk av pigpio-components, label=lst:pigpio-components-usage]
const button = new Button({ gpio: 24, isPullup: true });
const rgbLed1 = new RGBLed({ red: 25, green: 8, blue: 7 });
const rgbLed2 = new RGBLed({ red: 17, green: 27, blue: 22 });
const whiteLed = new Led(12);

button.on('click', () =>
  console.log('press and release within 500 ms'));
whiteLed.on();
rgbLed1.color('blue').on();
rgbLed2.color('#DC143C').strobe();
\end{lstlisting}

\subsection{GT-511C3}
Koden til fingeravtrykksensoren er en tynn abstraksjon over \gls{npm}-biblioteket \textit{GT-511C3}
\footnote{\url{https://github.com/the-AjK/GT-511C3}}, utgitt under BSD-3-lisens. Implementasjonen ligger
i filen \textit{index.js} i modulen \textit{fingerprint}
\footnote{\url{https://github.com/andybb/smart-pulse-oximeter/blob/master/fingerprint/index.js}}.
Denne modulen eksporterer to metoder: \textit{enrollFingerAndRetrieveTemplate} og \textit{setFingerprintTemplateAndVerify}.

Den første metoden går igjennom prosessen for å legge til et fingeravtrykk i databasen til sensoren, og henter ut et avtrykk
på 498 bytes. Dette avtrykket kan og bør lagres i en skytjeneste, men dette er ikke implementert i prototypen nå.
Den andre metoden har støtte for å ta inn et slikt avtrykk, og legge det inn i databasen til sensoren før avtrykket
verifiseres ved å legge riktig finger på sensoren. Prototypen antar nå at avtrykket er lagret på samme sted i databasen hver gang.

\subsection{Nonin 3230}
Utgaven av Nonin 3230 Trondheim kommune har kjøpt inn bruker en proprietær Bluetooth-tjeneste med 128-bit \gls{uuid}.
I nyere utgaver kan man også bruke den åpne spesifikasjonen til \textit{Bluetooth SIG Pulse Oximeter Service}.
Den proprietære tjenesten heter \textit{Nonin Oximetry Service} og har \gls{uuid} \textit{46a970e00d5f11e28b5e0002a5d5c51b}.
Tjenesten har to karakteristikker -- \textit{Nonin Oximetry Measurement} som sender data hvert sekund som spesifiert
i tabell \ref{table:nonin-datapacket} og \textit{Nonin Control Point} som kan brukes til å synkronisere skjermen,
indikere at en måling er ferdig, eller sette sikkerhetsmodus. 

Et \gls{npm}-biblotek (fotnote url) kalt \textit{nonin-3230-ble} ble utviklet for å gjøre integrasjonen mot sensoren enklere.
Biblioteket baserer seg på \textit{noble-device} (fotnote), og inneholder metoder for å oppdage et pulsoksimeter,
koble til, lytte etter ny sensordata og indikere at en måling er ferdig. Sensordata kommer som et JavaScript-objekt
og inneholder teller, pulsfrekvens, SpO2 og et statusobjekt (se tabell \ref{table:nonin-status}).
Koden er lagt ved i appendiks \ref{lst:nonin-3230-library}.
Eksempel på bruk kan finnes i kodesnutt \ref{lst:nonin-3230-usage}.

\begin{minipage}{\linewidth}
\begin{lstlisting}[frame=single, language=JavaScript,
    caption=Bruk av nonin-3230-ble, label=lst:nonin-3230-usage]
const Nonin3230 = require('nonin-3230-ble');

Nonin3230.discover((pulseOximeter) => {
  pulseOximeter.connectAndSetup((error) => {
    if (error) {
      console.error(error);
    }
    let counter = 0;
    // receive a new measurement every second
    pulseOximeter.on('data', (data) => {
      // data: { counter: int, pulseRate: int, oxygenSaturation: int, status: object }
      counter++;
      if (counter > 15) {
        pulseOximeter.stopMeasurement(() => console.log('Stopped'));
      }
    });
  });
});
\end{lstlisting}
\end{minipage}

Kildekoden er åpen og kan kjøres fra alle enheter som har støtte for Node og \gls{ble}.


\begin{table}[]
\centering
\begin{tabular}{|l|l|l}
\hline
\multicolumn{3}{|l|}{\textbf{Datapakke til pulsoksimeter}} \\ \hline
\textbf{Byte} & \textbf{Felt} & \multicolumn{1}{l|}{\textbf{Beskrivelse}} \\ \hline
1 & Lengde & Antallet bytes inkludert denne. \\ \hline
2 & Status & \multicolumn{1}{l|}{Indikerer nåværende enhetsstatus (tabell \ref{table:nonin-status}).} \\ \hline
3 & Batterispenning & \multicolumn{1}{l|}{Spenningsnivået til batteriene som brukes.} \\ \hline
4-5 & \begin{tabular}[c]{@{}l@{}}Perfusjonsindeks\\ (PI)\end{tabular} & \multicolumn{1}{l|}{PI = AC/DC*100\%} \\ \hline
6-7 & Teller & \multicolumn{1}{l|}{\begin{tabular}[c]{@{}l@{}}Verdien økes hvert sekund (0-65535). Kan bli brukt\\ til å sjekke at det ikke er noe datatap.\end{tabular}} \\ \hline
8 & SpO2 & \multicolumn{1}{l|}{SpO2-prosent, 0-100 (gjennomsnitt av fire slag).} \\ \hline
9-10 & Pulsfrekvens & \multicolumn{1}{l|}{\begin{tabular}[c]{@{}l@{}}Pulsfrekvens i slag per minutt, 0-321\\ (gjennomsnitt av fire slag).\end{tabular}} \\ \hline
\textgreater11 & Reservert & \multicolumn{1}{l|}{Reservert til fremtidig bruk} \\ \hline
\end{tabular}
\caption{Nonin 3230: Format på datapakke ref: nonin integration guide}
\label{table:nonin-datapacket}
\end{table}

\begin{table}[]
\centering
\begin{tabular}{|l|l|l}
\hline
\multicolumn{3}{|l|}{\textbf{Statusfelt (aktiv høy)}} \\ \hline
\textbf{Bit} & \textbf{Felt} & \multicolumn{1}{l|}{\textbf{Beskrivelse}} \\ \hline
7 & Reservert & Reservert til fremtidig bruk. \\ \hline
6 & Kryptering & \multicolumn{1}{l|}{\begin{tabular}[c]{@{}l@{}}1 = tilkoblingen er kryptert\\ 2 = tilkoblingen er ikke kryptert\end{tabular}} \\ \hline
5 & Lavt batteri & \multicolumn{1}{l|}{Batterinivået er lavt. Bytt batteri.} \\ \hline
4 & CorrectCheck & \multicolumn{1}{l|}{\begin{tabular}[c]{@{}l@{}}1 = OK\\ 2 = Plasser fingeren lengre inn i enheten\end{tabular}} \\ \hline
3 & Søker & \multicolumn{1}{l|}{Oksimeteret søker etter etterfølgende pulssignaler.} \\ \hline
2 & SmartPoint & \multicolumn{1}{l|}{\begin{tabular}[c]{@{}l@{}}Brukt til å indikere at dataen har bestått SmartPoint-\\ algoritmen.\end{tabular}} \\ \hline
1 & Lavt/svakt signal & \multicolumn{1}{l|}{\begin{tabular}[c]{@{}l@{}}Styrken til pulssignalet er 0,3 \% modulasjonsgrad\\ eller mindre.\end{tabular}} \\ \hline
0 & \begin{tabular}[c]{@{}l@{}}Indikering av\\ skjermsynkronisering\end{tabular} & \multicolumn{1}{l|}{\begin{tabular}[c]{@{}l@{}}Indikerer at skjermen er synkronisert med\\ innsamleren av data.\end{tabular}} \\ \hline
\end{tabular}
\caption{Nonin 3230: Format på statusfeltet til datapakke ref: nonin integration guide}
\label{table:nonin-status}
\end{table}

\subsection{3D-printet hus}
Det 3D-printede huset til prototypen er designet og printet ut av Terje Røsand basert på alle komponentstørrelsene i samarbeid
med Andreas Drivenes. Å integrere pulsoksimeteret i huset var den mest utfordrende delen av designet, og det gjorde at det ikke var
mulig å få plass til noen andre komponenter over denne sensoren. Alle de andre sensorene måtte plasseres til høyre for pulsoksimeteret.
Huset består av to uliker deler som klikkes sammen. Figur \ref{fig:3dmodell_topp1}
og figur \ref{fig:3dmodell_topp2} viser toppdelen, og figur \ref{fig:3dmodell_bunn} viser bunndelen.

Pulsoksimeteret og brettet med lysdioder og knapp skrus fast med tre skruer til toppdelen. Pulsoksimeteret presses mot toppdelen
med et innlagt, mykt materiale. Raspberry Pi Zero W skrus fast med fire skruer til bunndelen.

\begin{figure}
\includegraphics[width=0.65\textwidth, center]{fig/prototype/hoved_fra_topp}
\caption{3D-modell av prototype: Topp}
\label{fig:3dmodell_topp1}
\end{figure}
\begin{figure}

\includegraphics[width=0.65\textwidth, center]{fig/prototype/hoved_frabunn}
\caption{3D-modell av prototype: Topp, sett fra bunn}
\label{fig:3dmodell_topp2}
\end{figure}

\begin{figure}
\includegraphics[width=0.65\textwidth, center]{fig/prototype/bunn_fratopp}
\caption{3D-modell av prototype: Bunn}
\label{fig:3dmodell_bunn}
\end{figure}

\section{Serversideløsning}
\subsection{AWS IoT}
\subsection{AWS Lambda}
\subsection{InfluxDB og Grafana}

\subsection{Begrensninger med løsningen}
