%This is an Appendix
%%=========================================

\chapter{Kode}

\section{pigpio-components}
\label{appendix:pigpio-components}
Link til Github-repo med kode: \url{https://github.com/andybb/pigpio-components}.

\begin{lstlisting}[frame=single, language=JavaScript,
    caption=pigpio-components: Button class, label=lst:pigpio-components-button]
const EventEmitter = require('events');
const { Gpio } = require('pigpio');

class Button extends EventEmitter {
  constructor(options) {
    super();
    this._button = new Gpio(options.gpio, {
      mode: Gpio.INPUT,
      pullUpDown: options.isPullup ? Gpio.PUD_UP : Gpio.PUD_DOWN,
      edge: Gpio.EITHER_EDGE
    });
    this._timer = null;
    this._onInterrupt();
  }

  _onInterrupt() {
    let intervals = 0;
    this._button.on('interrupt', (value) => {
      if (value === 0) {
        this._timer = setInterval(() => {
          intervals++;
        }, 500);
      }
      else if (value === 1 && intervals === 0) {
        clearInterval(this._timer);
        intervals = 0;
        this.emit('click');
      }
      else if (value === 1 && intervals >= 4) {
        clearInterval(this._timer);
        intervals = 0;
        this.emit('long press');
      }
      else {
        if (this._timer) {
          clearInterval(this._timer);
          intervals = 0;
        }
      }

    });
  }
};

module.exports = Button;

\end{lstlisting}

\begin{lstlisting}[frame=single, language=JavaScript,
    caption=pigpio-components: Led classes, label=lst:pigpio-components-led]
const { Gpio } = require('pigpio');
const Color = require('color');

class Led {
  constructor(gpio) {
    this._led = new Gpio(gpio, { mode: Gpio.OUTPUT });
    process.on('SIGINT', () => {
      this.off();
      setTimeout(() => process.exit(1), 100);
    });
  }
  
  setValue(val) {
    if (val >= 0 && val < 256) {
      this._led.pwmWrite(val);
    }
    else {
      throw new Error('Value must be between 0 and 255');
    }
  }

  on() {
    this.setValue(255);
  }

  off() {
    this._led.digitalWrite(0);
  }
};

class RGBLed {
  constructor(ports) {
    this._leds =
      [new Led(ports.red), new Led(ports.green), new Led(ports.blue)];
    this._timer = null;
    this._rgb = Color.rgb(255, 255, 255).rgb().array();
    process.on('SIGINT', () => {
      this.stop();
      // Wait until other LEDs are cleaned up
      setTimeout(() => process.exit(1), 100);
    });
  }

  color(color) {
    this._rgb = Color(color).rgb().array();
    return this;
  }

  on() {
    this._leds.forEach((led, index) => led.setValue(this._rgb[index]));
    return this;
  }

  off() {
    this._leds.forEach((led) => led.off());
    return this;
  }
  
  stop() {
    this.off();
    if (this._timer) {
      clearInterval(this._timer);
    }
    return this;
  }

  strobe(interval = 1000) {
    if (this._timer) {
      clearInterval(this._timer);
    }

    let on = true; 
    this.on();
    this._timer = setInterval(() => {
      if (on) {
        this.off();
        on = false;
      }
      else {
        this.on();
        on = true;
      }
    }, interval);
    return this;
  }

  pulse(speed = 100) {
    if (this._timer) {
      clearInterval(this._timer);
    }

    let r = 0, g = 0, b = 0;
    this._timer = setInterval(() => {
      this._leds[0].setValue(r);
      this._leds[1].setValue(g);
      this._leds[2].setValue(b);
      r += 5;
      g += 7;
      b += 9;
      if (r > 255) {
        r -= 255;
      }
      if (g > 255) {
        g -= 255;
      }
      if (b > 255) {
        b -= 255;
      }
    }, speed);
    return this;
  }

  rainbow(speed = 500) {
    if (this._timer) {
      clearInterval(this._timer);
    }
    const colors = ['red', 'orange', 'yellow', 'green', 'blue', 'indigo', 'violet'];
    let index = 0;

    this._timer = setInterval(() => {
      this.color(colors[index]);
      this.on();
      index++;
      if (index > colors.length - 1) {
        index = 0;
      }
    }, speed);
    return this;
  }
}

module.exports = { RGBLed, Led };

\end{lstlisting}

\section{nonin-3230-ble}
Link til Github-repo med kode: \url{https://github.com/andybb/nonin-3230-ble}.

\begin{lstlisting}[frame=single, language=JavaScript,
    caption=Nonin 3230 noble-device library, label=lst:nonin-3230-library]
const NobleDevice = require('noble-device');

const SERVICE_UUID = '46a970e00d5f11e28b5e0002a5d5c51b';
const NOTIFY_CHAR  = '0aad7ea00d6011e28e3c0002a5d5c51b';

const Nonin3230 = function(peripheral)  {
  NobleDevice.call(this, peripheral);
};

Nonin3230.SCAN_UUIDS = [SERVICE_UUID];

Nonin3230.is = (peripheral) => (
    peripheral.advertisement.localName.indexOf('Nonin3230_') > -1
);

NobleDevice.Util.inherits(Nonin3230, NobleDevice);

NobleDevice.Util.mixin(Nonin3230, NobleDevice.BatteryService);
NobleDevice.Util.mixin(Nonin3230, NobleDevice.DeviceInformationService);

Nonin3230.prototype.onMeasurement = function(data) {
  const b = data[1];
  const status = {
    encryption: !!(b & 0x40),
    lowBattery: !!(b & 0x20),
    correctCheck: !!(b & 0x10),
    searching: !!(b & 0x8),
    smartPoint: !!(b & 0x4)
  }
  const counter = data.readInt16BE(5);
  const oxygenSaturation = data.readInt8(7);
  const pulseRate = data.readInt16BE(8);
  this.emit('data', { counter, oxygenSaturation, pulseRate, status });
};

Nonin3230.prototype.completeMeasurement = function(done) {
  this.writeDataCharacteristic(SERVICE_UUID, '1447af800d6011e288b60002a5d5c51b',
    new Buffer([0x62, 0x4E, 0x4D, 0x49]), done);
};

Nonin3230.prototype.connectAndSetup = function(callback) {
  NobleDevice.prototype.connectAndSetup.call(this, function(error) {
    this.notifyCharacteristic(SERVICE_UUID, NOTIFY_CHAR, true,
      this.onMeasurement.bind(this), function(err) {
        callback(err);
      });
  }.bind(this));
};

module.exports = Nonin3230;

\end{lstlisting}


\chapter{Formell henvendelse til Trondheim kommune}
\label{appendix:formell}
Til Prosjekt- og programledelsen Velferdsteknologi, Trondheim kommune

Vi søker med dette om samarbeid for en forskningsprosjekt for en masterstudent (Andreas Drivenes) ved Institutt for Datateknikk og Informatikk ved
NTNU innen området veldferdsteknologi med undertegnede som veileder. Prosjektet omhandler forbedring av brukervennlighet for pulsoksimeter til
avstandsoppfølging av kronisk syke. Bakgrunnen for prosjektet er et mangeårig samarbeid med SINTEF Helse v/Jarl Reitan rundt brukervennlighet og
design av veldferdsteknologi.

Vår kontaktperson i kommunen er Renate Enger, og hun har lånt oss et Nonin Pulsoksiometer som studenten har koblet opp mot en skytjeneste via
Bluetooth. Bakgrunnen for prosjektet er en mistanke om at en del kronisk syke vil ha problemer med tekniske løsninger for avstandsoppfølging dersom
de selv alene skal bruke måleutstyr som krever teknisk kunnskap, f.eks. oppkobling av bluetooth til nettbrett. Den nye s.k. Internet-of-Things
teknologien med direkte kobling til skytjenester gjør det mulig å ha måleutstyret direkte på internett, slik at man slipper å gå veien om f.eks. et
nettbrett. Vi tror dette vil kunne bedre brukervennligheten for kronisk syke, og gi en bedre tjenestekvalitet. Det vil muligens også kunne redusere
behovet for nettbrett for noen brukere.

Rent konkret så ser vi for oss følgende samarbeid med kommunen:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Fortsatt samarbeidet med Renate Enger i form av:

  \begin{itemize}
  \tightlist
  \item
    Ett intervju a maks to timer (mars)
  \item
    Feedback på teknisk løsning, maks to timer (april).
  \end{itemize}
\end{enumerate}

Hvis mulig ønsker vi også å få tilbakemelding fra helsearbeidere som er
nærmere feltet:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{1}
\tightlist
\item
  Fokusgruppe med 4-5 helsearbeidere som har erfaring med
  avstandsoppfølging av kronisk syke.

  \begin{itemize}
  \tightlist
  \item
    Hjelp til rekruttering av fokusgruppedeltagere.
  \item
    Frikjøp av helsearbeidere, maks en time. (april).
  \end{itemize}
\end{enumerate}

Med håp om konstruktivt samarbeid.

mvh
Dag Svanæs

\begin{verbatim}
__________________________________________________
Dag Svanæs, Professor, PhD
Department of Computer Science (IDI)
Norwegian University of Science and Technology (NTNU)
Trondheim, Norway
\end{verbatim}


\chapter{Invitasjoner til intervju}
\label{appendix:invitasjon_evaluering}

\section{Intervjuhenvendelse til Trondheim kommune (case-studie)}
Hei!

Har dere mulighet til å ta et intervju torsdag eller fredag i neste uke? Når som helst på dagen passer. 
Ellers så passer det når som helst på dagtid uka etter det igjen (27. mars - 31. mars).

Det hadde vært flott om jeg fikk lov til å ta opp intervjuet. Jeg kommer til å forberede noen skriftlige spørsmål
(som jeg kan sende på forhånd om dere ønsker),
men vi kan gjerne bevege oss litt utover det med oppfølgingsspørsmål om det passer seg sånn. 

Det hadde vært fint å titte kort på løsningen dere har nå etter intervjuet, og ta noen bilder av den.

Andreas

\section{Intervjuhenvendelse til Trondheim kommune og SINTEF (evaluering og oppsummering)}
Hei! 

Jeg har utviklet en prototype dere kan se på og teste, og som jeg gjerne vil ha tilbakemeldinger på.

Etter testen tenkte jeg at vi kunne snakke litt om hvordan brukere har opplevd løsningen som Trondheim kommune prøver nå, hva dere tenker om smarte
og integrerte sensorer som alltid er på nett, og hva som vil være viktig når det skal utvikles smarte velferdsteknologiprodukter for oppfølging av
kronisk syke i fremtiden.

Har dere mulighet til å møte meg i slutten av neste uke, eller tidlig uken etter det igjen (tidsrommene 26. - 28. april og 2. - 5. mai)? Jeg anslår
at det kommer til å ta en time til halvannen time, og jeg er veldig fleksibel på tidspunkt på dagtid. 

Vi kan godt møtes hos dere, Renate, hvis det er enklest for dere.

Andreas

\section{Intervjuhenvendelse til teknologileverandøren Imatis}
Hei! 

Mitt navn er Andreas Drivenes, og jeg går siste året på datateknologi på NTNU. Jeg skriver for tiden en masteroppgave
om avstandsoppfølging av kronisk syke i samarbeid med Trondheim kommune og SINTEF. Veilederen min er professor Dag Svanæs.

Jeg har fått låne et Nonin 3230-pulsoksimeter av Trondheim kommune som jeg har integrert med en Raspberry Pi Zero.
Den har en fingeravtrykkssensor, en knapp og to leds. Den publiserer sensordataen til AWS IoT, og jeg har satt opp en helt
enkel grafisk applikasjon som viser målingene. Koden til oppgaven kommer til å ligge åpent på Github.

Det ville være til stor hjelp for oppgaven om dere kunne snakke litt om hva slags teknologi dere bruker i løsningen deres i dag.

Rent konkret lurer jeg på om du (eller noen andre) kunne være med på et kort intervju på appear.in eller lignende? 
Jeg ser for meg at det kommer til å ta maks 30-45 minutter. Temaer for samtalen kommer til å være hvilken teknologi og arkitektur
dere bruker i løsningen for Trondheim kommune i dag, sikkerhet, tanker om prototypen og teknologien jeg har brukt, og den
digitale utviklingen i velferdsteknologi og avstandsoppfølging av kronisk syke i årene som kommer.

Jeg er ledig på dagtid det meste av den neste uken.

Jeg sender selvsagt en kopi av masteroppgaven når den blir ferdig i midten av juni.

\verb|--| \newline
Med vennlig hilsen \newline
Andreas Drivenes \newline

\chapter{Samtykkeerklæringer}

\section{Anonym}
\begin{center} \textit{Tingenes internett for avstandsoppfølging av kronisk syke \newline
Deltakelse på gruppeintervju}
\end{center}
\underline{Samtykkeerklæring} \newline
Jeg har mottatt muntlig informasjon om studien, og fått anledning til å stille spørsmål. Jeg er klar over at det er frivillig
å delta, og at jeg kan trekke meg fra studien når som helst uten å oppgi noen grunn. Jeg samtykker i å delta i studien.

Det vil bli tatt lydopptak.  Dette gjøres for at vi skal kunne vurdere intervjuene i etterkant og for å sikre oss at
vi har forstått utsagn og handlinger riktig. Vi vil sørge for at materiale vil bli anonymisert slik at det ikke vil
være mulig å føre opplysningene tilbake til enkeltpersonene som deltar i prosjektet. Dette innbærer at informasjon som
blir formidlet til offentligheten ikke vil kunne settes i sammenheng med den enkelte. Det er kun de involverte i prosjektet
som vil kunne se opptakene i ettertid.

Trondheim, \verb|_________________________|

\verb|_________________________|\newline
Navn

\verb|_________________________|\newline
Underskrift \newline

Masterstudent ansvarlig for studien: \newline
	Andreas Drivenes, e-mail: andreas.drivenes@gmail.com \newline
Faglig ansvarlig: \newline
	Professor Dag Svanæs, e-mail: dags@idi.ntnu.no \newline
Ansvarlig avdeling: \newline
	Institutt for Datateknologi og Informatikk (IDI), NTNU

\section{Ikke-anonym}
\begin{center} \textit{Tingenes internett for avstandsoppfølging av kronisk syke \newline
Deltakelse på gruppeintervju}
\end{center}
\underline{Samtykkeerklæring} \newline
Jeg har mottatt muntlig informasjon om studien, og fått anledning til å stille spørsmål. Jeg er klar over at det er frivillig
å delta, og at jeg kan trekke meg fra studien når som helst uten å oppgi noen grunn. Jeg samtykker i å delta i studien.

Det vil bli tatt lydopptak.  Dette gjøres for at vi skal kunne vurdere intervjuene i etterkant og for å sikre oss at vi har
forstått utsagn og handlinger riktig. Jeg samtykker i at mitt navn kan bli brukt i masteroppgaven og at det jeg sier kobles
til mine utsagn. Jeg blitt informert om at jeg har fått mulighet til å lese igjennom referatene fra intervjuene og
kommentere på eventuelle feil i transkribering. 

Det er kun de involverte i prosjektet som vil kunne høre opptakene i ettertid.

Trondheim, \verb|_________________________|

\verb|_________________________|\newline
Navn

\verb|_________________________|\newline
Underskrift \newline

Masterstudent ansvarlig for studien: \newline
	Andreas Drivenes, e-mail: andreas.drivenes@gmail.com \newline
Faglig ansvarlig: \newline
	Professor Dag Svanæs, e-mail: dags@idi.ntnu.no \newline
Ansvarlig avdeling: \newline
	Institutt for Datateknologi og Informatikk (IDI), NTNU